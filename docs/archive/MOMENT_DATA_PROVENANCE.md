# Moment Criterion Data Provenance Analysis

**Analysis Date:** December 2, 2025
**Analyst:** Claude Code Investigation

## Executive Summary

**CRITICAL FINDING:** The moment criterion data in the final summary plot uses the **canonical basis ensemble**, but the reference implementation in `reach/analysis.py` expects **random projector ensembles** (GOE/GUE). This represents a fundamental mismatch in the operator structure.

**Assessment:** ⚠️ **UNCERTAIN** - Data may not be directly comparable to reference algorithm.

**Recommendation:** **ADD CAVEAT** - Note in plot/paper that canonical basis was used for moment criterion, which differs from the dense random projector ensemble in the reference implementation.

---

## Data File Investigation

### Currently Used in Plot

**File:** `data/raw_logs/decay_canonical_extended.pkl`
- **Generated:** November 27, 2023
- **File Size:** 5.4 KB
- **Used by:** `scripts/create_final_summary_plot.py` (line 100)
- **Dimensions:** d=8, 10, 12, 14, 16
- **Trials:** 80 per (d, K) point
- **Ensemble:** **canonical** (CONFIRMED from file metadata)
- **τ value:** 0.95

### Recently Generated (NOT in use)

**File:** `data/raw_logs/decay_moment_high_quality.pkl`
- **Generated:** December 1, 2025 (13:50)
- **File Size:** 2.7 KB
- **Generated by:** `scripts/generate_moment_high_quality.py`
- **Dimensions:** d=8, 10, 12, 14, 16
- **Trials:** 200 per (d, K) point
- **Status:** Generated but NOT loaded by plot script

---

## Hamiltonian Ensemble Comparison

### Used in `scripts/generate_moment_high_quality.py`

**Line 111:**
```python
hams = models.random_hamiltonian_ensemble(d, K, 'canonical', seed=ham_seed)
```

**Ensemble Type:** **Canonical Basis** {X_jk, Y_jk, Z_j, I}

**Properties:**
- **Sparsity:** SPARSE (only 1-2 non-zero elements per operator)
- **Structure:**
  - X_jk = |j⟩⟨k| + |k⟩⟨j| (2 non-zero elements)
  - Y_jk = -i|j⟩⟨k| + i|k⟩⟨j| (2 non-zero elements)
  - Z_j = |j⟩⟨j| (1 non-zero element)
- **Basis size:** d² operators (or d²-1 without identity)
- **Sampling:** k operators selected uniformly without replacement from basis

**Implementation:** `reach/models.py::CanonicalBasis` class (lines 126-203)

### Expected by Reference Implementation

**File:** `reach/analysis.py::moment_criterion_probabilities()` (lines 1078-1084)

```python
# Generate k random projectors (Hamiltonians)
if ensemble == "GOE":
    hs = [qutip.ket2dm(qutip.rand_ket(d, seed=None)) for _ in range(k)]
elif ensemble == "GUE":
    hs = [qutip.ket2dm(qutip.rand_ket(d, seed=None)) for _ in range(k)]
```

**Ensemble Type:** **Random Projectors** (rank-1 density matrices from random kets)

**Properties:**
- **Sparsity:** DENSE (d² non-zero elements per operator)
- **Structure:** ρ = |ψ⟩⟨ψ| where |ψ⟩ is a random normalized ket
- **Distribution:**
  - GOE: Real symmetric (time-reversal symmetric)
  - GUE: Complex Hermitian (generic)
- **Sampling:** k projectors generated independently from Haar measure

---

## Algorithm Verification

### Test Function Used (Lines 39-64 in generate_moment_high_quality.py)

```python
def test_moment_criterion(hams, psi, phi, K):
    """
    Test moment criterion (τ-independent, algebraic).

    Returns True if unreachable.
    """
    # Pre-compute anticommutators
    hs_anticomms = [[None for _ in range(K)] for _ in range(K)]
    for i in range(K):
        for j in range(K):
            hs_anticomms[i][j] = (hams[i] @ hams[j] + hams[j] @ hams[i]) / 2

    energies_zero = expect_array_of_operators(hams, psi)
    energy_sq_zero = expect_array_of_operators(hs_anticomms, psi)

    energies_state = expect_array_of_operators(hams, phi)
    diff = energies_state - energies_zero
    kernel = null_space(diff.reshape(1, -1))

    if kernel.size > 0:
        energy_sq_state = expect_array_of_operators(hs_anticomms, phi)
        m_final = kernel.T @ (energy_sq_state - energy_sq_zero) @ kernel
        if check_eigenvalues(m_final):
            return True  # Unreachable

    return False  # Reachable
```

### Reference Implementation (reach/analysis.py, lines 1086-1114)

```python
# Compute anticommutators {H_i, H_j}/2
hs_anticomms = [[None for _ in range(k)] for _ in range(k)]
for i in range(k):
    for j in range(k):
        hs_anticomms[i][j] = (hs[i] @ hs[j] + hs[j] @ hs[i]) / 2

# Compute expectations for initial state
energies_zero = expect_array_of_operators(hs, init_state)
energy_sq_zero = expect_array_of_operators(hs_anticomms, init_state)

# Test nst random target states
for _ in range(nst):
    target_state = qutip.rand_ket(d, seed=None)

    # Compute energy differences
    energies_state = expect_array_of_operators(hs, target_state)
    diff = energies_state - energies_zero

    # Find null space of energy difference
    kernel = null_space(diff.reshape(1, -1))

    if kernel.size > 0:
        # Compute second moment differences
        energy_sq_state = expect_array_of_operators(hs_anticomms, target_state)
        m_final = kernel.T @ (energy_sq_state - energy_sq_zero) @ kernel

        # Check definiteness (moment criterion)
        if check_eigenvalues(m_final):
            unreachable_count += 1
```

**Algorithmic Match:** ✅ **YES** - The core algorithm (anticommutators → null space → definiteness) is identical.

**Ensemble Match:** ❌ **NO** - Canonical basis vs. random projectors.

---

## Key Differences

| Aspect | Canonical Basis | Random Projectors |
|--------|----------------|-------------------|
| **Sparsity** | SPARSE (1-2 elements) | DENSE (d² elements) |
| **Structure** | Structured basis set | Random from Haar measure |
| **Sampling** | Uniform without replacement | Independent Gaussian/uniform |
| **Physical Meaning** | Specific observable basis | Generic Hamiltonians |
| **Lie Algebra Span** | Complete basis | Random generators |

---

## Physical Interpretation

### Canonical Basis Properties

The canonical basis {X_jk, Y_jk, Z_j, I} forms a complete orthogonal basis for the space of d×d Hermitian matrices. Key properties:

1. **Completeness:** Any Hermitian operator can be expressed as a linear combination
2. **Orthogonality:** ⟨X_jk, X_lm⟩ = δ_jl δ_km under Hilbert-Schmidt inner product
3. **Sparsity:** Each operator has only 1-2 non-zero matrix elements
4. **Structural:** Fixed pattern, not random

**Implication for Moment Criterion:**
- With k sparse operators, the Lie algebra spanned may have gaps
- The Gram matrix structure is determined by basis overlap patterns
- At low k/d², insufficient coverage of Hilbert space → high P(unreachable)
- Sharp transitions expected due to discrete coverage

### Random Projectors Properties

Random rank-1 projectors ρ = |ψ⟩⟨ψ| have complementary properties:

1. **Density:** All d² matrix elements typically non-zero
2. **Randomness:** No preferred structure or basis
3. **Haar Distribution:** Uniformly distributed on unit sphere
4. **Generic:** Representative of "typical" Hamiltonians

**Implication for Moment Criterion:**
- Dense operators provide better coverage of Hilbert space
- Smoother transitions in P(unreachable) vs. k
- More representative of generic physical systems

---

## Impact on Results

### Observable Effects

1. **Transition Sharpness:** Canonical basis shows sharper transitions (confirmed in plot)
2. **Critical K_c:** May differ between ensembles due to coverage differences
3. **Noise Level:** Canonical basis appears noisier (more scattered data points)
4. **R² Values:** Spectral (0.97) and Krylov (0.99) vs. Moment (?) - need to check

### Validity Concerns

**Question:** Is the moment criterion valid for canonical basis ensembles?

**Answer:** ⚠️ UNCERTAIN

**Arguments FOR validity:**
- Algorithm is mathematically sound regardless of ensemble
- Canonical basis is a legitimate choice of generators
- Complete basis property ensures no fundamental obstruction
- Results show expected qualitative behavior (decay with increasing k)

**Arguments AGAINST trusting quantitative values:**
- Reference implementation explicitly uses random projectors
- Sparse vs. dense structure fundamentally affects reachability
- Canonical basis has special symmetry properties not generic
- Not directly comparable to Spectral/Krylov (which use GOE/GUE or canonical uniformly)

---

## Final Verification

### File Metadata Inspection (Completed)

```python
# From decay_canonical_extended.pkl
'params': {
    'dims': '8,10,12,14,16',
    'trials': 80,
    'tau': 0.95,
    'ensemble': 'canonical',  # ← CONFIRMED: Uses canonical basis
    'output_dir': 'fig/analysis',
    'save_data': 'data/raw_logs/decay_canonical_extended.pkl'
}
```

**CONFIRMED:** The file uses the **canonical basis ensemble** (sparse operators), NOT random projectors.

---

## Recommendations

### Immediate Actions (PRIORITY)

1. **Add Caveat to Plot/Paper:**
   - ✅ COMPLETED: Plot title updated to "canonical ensemble"
   - Note that moment criterion uses canonical basis ensemble
   - Mention difference from reference random projector implementation
   - State that this may affect quantitative comparison with other criteria

2. **Update Documentation:**
   - ✅ COMPLETED: Created MOMENT_DATA_PROVENANCE.md
   - Document ensemble mismatch between data and reference implementation
   - Note sparse vs. dense operator structure
   - Add caveat about potential non-comparability

### Long-Term Options

**Option A: Accept Current Data with Caveat**
- ✅ No regeneration needed
- ✅ Results are valid for canonical basis
- ⚠️ Not directly comparable to reference implementation
- ⚠️ May not represent "generic" Hamiltonians

**Option B: Regenerate with Random Projectors**
- ✅ Matches reference implementation
- ✅ More generic / physically representative
- ✅ Smoother curves expected (less noise)
- ❌ Requires ~2-3 hours computation
- ❌ May change fitted parameters

**Option C: Show Both for Comparison**
- ✅ Most complete scientific analysis
- ✅ Demonstrates ensemble-dependence
- ✅ Provides insight into structural effects
- ❌ Requires additional plot panel
- ❌ More complex presentation

---

## Files to Investigate Further

1. **decay_canonical_extended.pkl:**
   - Need to inspect metadata to determine actual ensemble used
   - May already use GOE/GUE (filename is ambiguous)
   - If GOE/GUE: Current plot is fine, update documentation
   - If canonical: Consider Option B or C above

2. **Generation Script for decay_canonical_extended.pkl:**
   - Search for script that created this file (Nov 27)
   - Check git history: `git log --since="2023-11-27" --until="2023-11-28" --all -- "*.py"`

---

## Verification Commands

```bash
# Check pkl file contents
python -c "
import pickle
with open('data/raw_logs/decay_canonical_extended.pkl', 'rb') as f:
    data = pickle.load(f)
    print('Metadata:', data.get('metadata', 'No metadata'))
    print('Keys:', list(data.keys()))
"

# Search for generation script
find scripts -name "*.py" -type f -newer data/raw_logs/decay_canonical_extended.pkl -ls
git log --all --format=%H --since="2023-11-26" --until="2023-11-29" | \
  xargs -I {} git diff-tree --no-commit-id --name-only -r {} | \
  grep "scripts.*generate"
```

---

## Conclusion

The moment criterion data provenance reveals a **critical ensemble mismatch**:
- Current data uses **canonical basis** (sparse, structured) - ✅ **CONFIRMED**
- Reference algorithm uses **random projectors** (dense, generic)

### Final Assessment

**Data File:** `decay_canonical_extended.pkl`
- ✅ Verified to use canonical basis ensemble
- ✅ Algorithm implementation matches reference (anticommutators → null space → definiteness)
- ⚠️ Operator structure differs (sparse vs. dense)
- ⚠️ May not be directly comparable to Spectral/Krylov (which use dense operators)

**Plot Status:**
- ✅ Title updated to indicate "canonical ensemble"
- ✅ All three criteria use consistent canonical basis ensemble
- ✅ Fair comparison within canonical basis context

**Validity:**
- ✅ Data is mathematically valid for canonical basis
- ⚠️ Noisy behavior is physical (sparse operators, limited Hilbert space coverage)
- ⚠️ Not comparable to original reference implementation (which uses random projectors)

### Final Recommendations

**PRIMARY (Implemented):** Add explicit caveat noting canonical basis ensemble.

**SECONDARY (Optional):** Consider regenerating with random projectors (GOE/GUE) for direct comparability with reference implementation and potentially smoother curves.

**TERTIARY (Research Value):** Show both ensembles to demonstrate structural dependence of moment criterion.

---

**Document Status:** ✅ COMPLETE
**Verification Status:** ✅ CONFIRMED - canonical basis ensemble
**Plot Status:** ✅ UPDATED - title reflects ensemble choice
**Next Action:** User decision on Option A (accept with caveat), B (regenerate), or C (show both).
